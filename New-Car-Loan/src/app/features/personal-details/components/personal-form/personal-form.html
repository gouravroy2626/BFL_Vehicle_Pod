<!-- Drawer overlay displayed initially -->
<app-drawer [isOpen]="isDrawerOpen" [selectedOption]="selectedOption" [showError]="showError"
  [isContentVisible]="isContentVisible" (close)="onDrawerClose()" (continue)="onDrawerContinue($event)"
  (toggleContent)="onDrawerToggleContent()" (optionChange)="onDrawerOptionChange($event)">
</app-drawer>



<div class="form-container" [class.blurred]="isDrawerOpen">
  <p class="p-title">
    {{ fieldMap['title']?.title }}
  </p>
  <p class="p-discription">
    {{ fieldMap['title']?.subtitle }}
  </p>

  <div class="form-field">
    <label for="pan-input">
      {{ fieldMap['full-name']?.title }}  <span class="required">*</span>
    </label>

  <input type="text" class="form-control" id="pan-input"
  [attr.placeholder]="fieldMap['full-name']?.placeholder || 'Enter full name'"
    [(ngModel)]="fullName" (input)="onFullNameInput($event); setTyping($event)" (blur)="onBlurRemoveTyping($event)"
    [disabled]="!!fullNameFromDrawer">
    @if (showErrors && !fullName.trim()) {
    <div class="field-error"><img src="/Frame 1707485144.svg" alt="Error"><span>Please enter your full name</span></div>
    }
  </div>

  <div class="form-field">
    <label>{{ fieldMap['gender-tab']?.['field-label-main'] }} <span class="required">*</span></label>
    <div class="gender-selector">
      @for (option of fieldMap['gender-tab']?.['radio-group']; track option?.['field-item-key']) {
      <label>
        <input type="radio" name="gender" [value]="option?.['field-item-key']" class="gender-radio"
          [(ngModel)]="gender">
        {{ option?.['field-item-text'] || option?.['event-prop-value'] }}
      </label>
      }
    </div>
    @if (showErrors && !gender) {
    <div class="field-error"><img src="/Frame 1707485144.svg" alt="Error"><span>Please select Gender</span></div>
    }
  </div>

  <div class="form-field">
    <label for="dob-input">{{ fieldMap['date-of-birth']?.title }} <span class="required">*</span></label>
  <input type="text" class="form-control" id="dob-input" [attr.placeholder]="fieldMap['date-of-birth']?.placeholder || 'dd/mm/yyyy'"
      [(ngModel)]="dob" maxlength="10" pattern="\d{2}/\d{2}/\d{4}" (input)="onDobInput($event); setTyping($event)"
      (blur)="onBlurRemoveTyping($event)">

    @if (showErrors && !dob) {
    <div class="field-error"><img src="/Frame 1707485144.svg" alt="Error"><span>Please enter your date of birth</span>
    </div>
    }
    @if (showErrors && dob && !isAgeValid()) {
    <div class="field-error"><img src="/Frame 1707485144.svg" alt="Error"><span>Age must be between 18 and 65 to
        apply</span></div>
    }
  </div>

  <div class="form-field">
    @let panInfo = fieldMap['pan-wrapper']?.group?.[0];
    <label for="pan-number-input">
      {{ panInfo?.title || panInfo?.icontitle || panInfo?.['event-prop-value'] }}
      <span class="required">*</span>
      @if (panInfo?.['iconimage-android']) {
      <img [src]="panInfo?.['iconimage-android']"
        [attr.alt]="panInfo?.icontitle || panInfo?.['event-prop-value']" 
        class="pan-info-icon"
        (click)="openDrawerForPan()" />
      }
    </label>

    <input type="text" class="form-control" id="pan-number-input"
      [attr.placeholder]="panInfo?.placeholder || 'Enter 10-character alphanumeric PAN'" [(ngModel)]="pan"
      (input)="onPanInput($event); setTyping($event)" (blur)="onBlurRemoveTyping($event)" maxlength="10">
    @if (showErrors && !isPanValid()) {
    <div class="field-error"><img src="/Frame 1707485144.svg" alt="Error"><span>Invalid PAN card number. Please enter a
        valid 10-character alphanumeric PAN</span></div>
    }
  </div>
  <div class="form-field">
    <label for="employment-type-display">
      {{ fieldMap['employment-type-wrapper']?.group?.[0]?.title }}
       <span
        class="required">*</span></label>
    <div id="employment-type-display" class="form-control employment-display" (click)="openEmploymentModal()">
      @if (!employmentType) {
      <span class="placeholder1">{{ fieldMap['employment-type-wrapper']?.group?.[1]?.['field-label-main'] }}</span>
      }
      @if (employmentType==='salaried') {
      <span>{{ getEmploymentLabel('salaried') }}</span>
      }
      @if (employmentType==='self-employed') {
      <span>{{ getEmploymentLabel('self-employed') }}</span>
      }
      <img class="chevron" src="/Icon (Stroke).svg" alt="Chevron" />
    </div>
    @if (showErrors && !employmentType) {
    <div class="field-error"><img src="/Frame 1707485144.svg" alt="Error"><span>Please select employment type</span>
    </div>
    }
    @if (employmentType === 'salaried') {
    <div class="salary-field">
      <label for="salary-input">{{ fieldMap['net-monthly-salary']?.title }} <span class="required">*</span></label>
      <input id="salary-input" type="text" class="form-control"
        [attr.placeholder]="fieldMap['net-monthly-salary']?.placeholder || 'Enter monthly take-home salary'" [(ngModel)]="monthlySalaryDisplay"
        (input)="onSalaryInput($event); setTyping($event)" (blur)="onBlurRemoveTyping($event)">
      @if (showErrors && !isSalaryValid()) {
      <div class="field-error"><img src="/Frame 1707485144.svg" alt="Error"><span>Please enter salary between 15000 to
          75000</span></div>
      }
    </div>
    }
    @else if (employmentType==='self-employed') {
    <div class="salary-field">
      @let gstInfo = fieldMap['gst-wrapper']?.group?.[0];
      <label for="gstin-input">{{ gstInfo?.title || gstInfo?.icontitle || gstInfo?.['event-prop-value'] }}
        @if (gstInfo?.['iconimage-android']) {
        <img [src]="gstInfo?.['iconimage-android']"
          [attr.alt]="gstInfo?.icontitle || gstInfo?.['event-prop-value']" class="pan-info-icon"
          (click)="openDrawerForGstin()" />
        }
      </label>
      <input id="gstin-input" type="text" class="form-control"
        [attr.placeholder]="gstInfo?.placeholder || 'Enter your GSTIN'" [(ngModel)]="gstin"
        (input)="onGstInput($event); setTyping($event)" (blur)="onBlurRemoveTyping($event)">
    </div>
    }
  </div>

  @if (employmentModalOpen) {
  <div class="employment-modal-wrapper" role="dialog" aria-modal="true">
    <div class="employment-modal">
      <div class="employment-modal-header">
        <h5>{{ fieldMap['employment-type-wrapper']?.group?.[1]?.['field-label-main'] }}</h5>
        <button type="button" class="close-x" (click)="closeEmploymentModal()" aria-label="Close">&times;</button>
      </div>
      <ul class="employment-options">
        @for (option of fieldMap['employment-type-wrapper']?.group?.[1]?.['dropdown-text-box']; track
        option?.['dropdown-values']) {
        <li
          (click)="selectEmploymentType((option?.['dropdown-values'] || option?.['event-prop-value'] || '').toLowerCase().includes('self') ? 'self-employed' : 'salaried')"
          [class.active]="employmentType===((option?.['dropdown-values'] || option?.['event-prop-value'] || '').toLowerCase().includes('self') ? 'self-employed' : 'salaried')">
          {{ option?.['dropdown-values'] || option?.['event-prop-value'] }}
        </li>
        }
      </ul>
    </div>
    <div class="employment-backdrop" (click)="closeEmploymentModal()"></div>
  </div>
  }
  <div class="form-field">
    <label for="pincode-input">{{ fieldMap['residential-pin']?.title }} <span class="required">*</span></label>
    <input type="text" class="form-control" id="pincode-input"
      [attr.placeholder]="fieldMap['residential-pin']?.placeholder || 'Enter 6-digit current PIN code'" [(ngModel)]="pincode"
      (input)="onPincodeInput($event); setTyping($event)" (blur)="onBlurRemoveTyping($event)" maxlength="6">
    @if (showErrors && !isPincodeValidLocal()) {
    <div class="field-error"><img src="/Frame 1707485144.svg" alt="Error"><span>Please enter a valid 6-digit PIN
        code</span></div>
    }
  </div>
  @if (isPincodeValid()) {
  <div class="form-field">
    <label for="city-input">{{ fieldMap['residential-city']?.title }}</label>
    <input type="text" class="form-control" id="city-input"
      [attr.placeholder]="fieldMap['residential-city']?.placeholder || 'City'" [value]="city" disabled>
  </div>
  }
  <div class="consent-group">
    <!-- T&C consent -->
    <label class="consent-item" [ngClass]="{'tnc-error': showErrors && !tncAccepted}">
      <input type="checkbox" class="consent-checkbox" [(ngModel)]="tncAccepted" (change)="onConsentChange()" />
      <span class="consent-visual" aria-hidden="true"></span>
      <span class="consent-text">
        I have read, understood, and hereby accept the product
        <span class="terms-conditions">
          <a target="_blank" rel="noopener noreferrer" href="https://www.bajajfinserv.in/tnc-retail-lending" class="link">Terms and Conditions.</a>
        </span>
      </span>
    </label>
    <hr>
    <!-- Credit consent -->
    <label class="consent-item" [ngClass]="{'tnc-error': showErrors && !creditConsent}">
      <input type="checkbox" class="consent-checkbox" [(ngModel)]="creditConsent" (change)="onConsentChange()" />
      <span class="consent-visual" aria-hidden="true"></span>
      <span class="consent-text" [innerHTML]="fieldMap['tnc-two']?.description"></span>
    </label>
    <hr>
    <!-- Optional marketing consent -->
    <label class="consent-item optional">
      <input type="checkbox" class="consent-checkbox" [(ngModel)]="marketingOptIn" />
      <span class="consent-visual" aria-hidden="true"></span>
      <span class="consent-text" [innerHTML]="fieldMap['tnc-three']?.description"></span>
    </label>
  </div>



</div>
<div class="button-box-with-shadow">
  @if (showErrors && hasAnyErrors()) {
  <div class="error-summary">
    <img src="/Frame 1707485144.svg" alt="Error" class="error-icon" />
    @if (!tncAccepted || !creditConsent) {
    <span>Please accept our terms and conditions to proceed.</span>
    }
    @if (tncAccepted && creditConsent) {
    <span>There are errors on this screen</span>
    }
  </div>
  }
  <div class="button-row">
    <button type="button" class="btn-outline" (click)="saveToCart()">{{ fieldMap['button-section']?.ctalabel1
      }}</button>
    <button type="button" class="btn-primary" (click)="onContinue()">{{ fieldMap['button-section']?.ctalabel2
      }}</button>
  </div>
</div>

  <app-save-to-cart #saveToCartRef></app-save-to-cart>
  <app-pan-drawer-service #panDrawerRef></app-pan-drawer-service>
  <app-gst-drawer-service #gstDrawerRef></app-gst-drawer-service>



